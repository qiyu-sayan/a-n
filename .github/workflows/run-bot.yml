name: run-bot

on:
  schedule:
    # æ¯ 5 åˆ†é’Ÿè·‘ä¸€æ¬¡ï¼ˆä½ å¯ä»¥è‡ªå·±è°ƒèŠ‚ï¼‰
    - cron: "*/5 * * * *"
  workflow_dispatch:

permissions:
  contents: read

jobs:
  trade:
    runs-on: self-hosted

    steps:
      - name: Checkout repo
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"

      - name: Install deps
        run: |
          python -m pip install --upgrade pip
          # å…ˆè£… requestsï¼Œé¿å… requirements.txt é‡Œæ²¡å†™
          pip install requests
          if [ -f requirements.txt ]; then
            pip install -r requirements.txt
          fi

      # ------ è¿è¡Œå‰æ¨é€åˆ°ä¼ä¸šå¾®ä¿¡ï¼ˆå¯é€‰ï¼‰ ------
      - name: Notify WeCom BEFORE run
        if: ${{ secrets.WECHAT_WEBHOOK != '' }}
        env:
          WECHAT_WEBHOOK: ${{ secrets.WECHAT_WEBHOOK }}
          MSG: |
            ğŸ¤– run-bot å³å°†è¿è¡Œ
            Repo: ${{ github.repository }}
            Branch: ${{ github.ref_name }}
            Commit: ${{ github.sha }}
            Run: #${{ github.run_number }}
        run: |
          python .github/scripts/wecom_notify.py || echo "wecom notify before failed"

      # ------ è¿è¡Œäº¤æ˜“ Bot ------
      - name: Run trading bot
        env:
          # è¿™é‡Œç”¨çš„æ˜¯ä½  GitHub é‡Œé…ç½®çš„ Secrets
          BINANCE_KEY: ${{ secrets.BINANCE_KEY }}
          BINANCE_SECRET: ${{ secrets.BINANCE_SECRET }}

          # ç”¨ TESTNETï¼ˆæ¨¡æ‹Ÿç›˜ï¼‰è¿˜æ˜¯å®ç›˜ï¼š
          # ä½ ç°åœ¨æ˜¯ç”¨ demo.binance.com åˆ›å»ºçš„æµ‹è¯•ç½‘å¯†é’¥ï¼Œæ‰€ä»¥ä¿æŒ true
          TESTNET: "true"

          # æ˜¯å¦çœŸæ­£ä¸‹å•ï¼›å¦‚æœä½ æƒ³åªçœ‹æ—¥å¿—å…ˆä¸ä¸‹å•ï¼Œå¯ä»¥æ”¹æˆ "false"
          ENABLE_TRADING: "true"

          # å¯é€‰ï¼šè¿™äº›ä¸è®¾å°±ç”¨ main.py é‡Œçš„é»˜è®¤/params.json
          # SYMBOLS: "BTCUSDT,ETHUSDT"
          # ORDER_USDT: "10"
          # PAPER: "false"
        run: |
          mkdir -p logs
          python bot/main.py 2>&1 | tee "logs/run-$(date -u '+%Y-%m-%dT%H-%M-%SZ').log"

      # ------ è¿è¡Œåæ¨é€åˆ°ä¼ä¸šå¾®ä¿¡ï¼ˆå¯é€‰ï¼‰ ------
      - name: Notify WeCom AFTER run
        if: ${{ secrets.WECHAT_WEBHOOK != '' }}
        env:
          WECHAT_WEBHOOK: ${{ secrets.WECHAT_WEBHOOK }}
          MSG: |
            âœ… run-bot è¿è¡Œç»“æŸ
            Repo: ${{ github.repository }}
            Branch: ${{ github.ref_name }}
            Commit: ${{ github.sha }}
            Run: #${{ github.run_number }}
        run: |
          python .github/scripts/wecom_notify.py || echo "wecom notify after failed"
