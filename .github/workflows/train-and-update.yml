name: train-and-update

on:
  schedule:
    - cron: "0 */6 * * *"   # 每6小时
  workflow_dispatch:

permissions:
  contents: write

jobs:
  train:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repo
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"

      - name: Install deps
        run: |
          python -m pip install --upgrade pip
          if [ -f requirements.txt ]; then pip install -r requirements.txt; fi

      - name: Validate params.json
        run: |
          python -c "import json;json.load(open('config/params.json','rb'));print('params.json OK')"

      - name: Notify WeCom BEFORE training
        if: ${{ secrets.WECHAT_WEBHOOK != '' }}
        env:
          WECHAT_WEBHOOK: ${{ secrets.WECHAT_WEBHOOK }}
          MSG: |
            Training start #${{ github.run_number }}
            Branch: ${{ github.ref_name }}
            Commit: ${{ github.sha }}
        run: |
          python -u bot/wecom_notify.py

      - name: Run training
        run: |
          python -m trainer.train

      - name: Compare metrics & decide promotion
        shell: bash
        run: |
          set -e
          NEW="trainer/metrics.json"
          BASE="trainer/metrics_baseline.json"
          if [ ! -f "$BASE" ]; then cp "$NEW" "$BASE"; fi

          py=$(cat <<'PY'
          import json
          new=json.load(open("trainer/metrics.json"))
          base=json.load(open("trainer/metrics_baseline.json"))
          promote = (new.get("sharpe",0)>base.get("sharpe",0) and new.get("max_dd",1)<=base.get("max_dd",1)) \
                    or (new.get("pnl",0)>base.get("pnl",0))
          print("PROMOTE=1" if promote else "PROMOTE=0")
          PY
          )
          eval=$(python - <<<$py)
          echo "$eval" | tee promote.flag

      - name: Commit updated params.json
        if: always()
        shell: bash
        run: |
          if grep -q "PROMOTE=1" promote.flag; then
            echo "Promote new params & baseline metrics"
            cp trainer/metrics.json trainer/metrics_baseline.json
            git config user.name  "github-actions[bot]"
            git config user.email "github-actions[bot]@users.noreply.github.com"
            git add config/params.json trainer/metrics_baseline.json
            git commit -m "promote: better params via training #${{ github.run_number }}" || echo "nothing to commit"
            git push
          else
            echo "No promotion"
          fi

      - name: Notify WeCom AFTER training
        if: ${{ secrets.WECHAT_WEBHOOK != '' }}
        env:
          WECHAT_WEBHOOK: ${{ secrets.WECHAT_WEBHOOK }}
          MSG: |
            Training done - ${{ job.status }}
            Promote: $(cat promote.flag)
            Run: ${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}
        run: |
          python -u bot/wecom_notify.py